VERSION 0.7
FROM python:3.11
WORKDIR /server

deps:
    RUN pip install poetry
    COPY pyproject.toml ./
    COPY poetry.lock ./
    RUN poetry install

dev:
    FROM +deps
    COPY . .
    RUN poetry run uvicorn backend.api.app:app --reload --port 8080

build:
    FROM +deps
    COPY . .
    COPY dist dist
    SAVE ARTIFACT backend /backend
    SAVE ARTIFACT dist /dist

docker:
    COPY +build/backend
    ARG tag="latest"
    ENTRYPOINT ["python3", "/.backend"]
    SAVE IMAGE ongkagu-backend:$tag

check-format:
    FROM +deps
    COPY . backend
    RUN poetry install
    RUN poetry run ruff ./backend/
